# Linuxä¸­tcpçš„æºç å™è¿°

## å¯ç¤ºï¼š

è¿™æ˜¯ä¸€ä¸ªæ ‡å‡†çš„sockek-tcpè¿æ¥è¿‡ç¨‹

```c
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <arpa/inet.h>

#define PORT 8080
#define BUFFER_SIZE 1024

int main() {
    int server_fd, client_fd;
    struct sockaddr_in server_addr, client_addr;
    socklen_t client_len;
    char buffer[BUFFER_SIZE];

    // 1. åˆ›å»º socket
    server_fd = socket(AF_INET, SOCK_STREAM, 0);
    if (server_fd == -1) {
        perror("socket failed");
        exit(EXIT_FAILURE);
    }

    // 2. ç»‘å®š IP å’Œç«¯å£
    server_addr.sin_family = AF_INET;
    server_addr.sin_addr.s_addr = INADDR_ANY;  // ç›‘å¬æ‰€æœ‰åœ°å€
    server_addr.sin_port = htons(PORT);  // ç«¯å£

    if (bind(server_fd, (struct sockaddr *)&server_addr, sizeof(server_addr)) < 0) {
        perror("bind failed");
        close(server_fd);
        exit(EXIT_FAILURE);
    }

    // 3. ç›‘å¬ç«¯å£
    if (listen(server_fd, 5) < 0) {
        perror("listen failed");
        close(server_fd);
        exit(EXIT_FAILURE);
    }

    printf("Server listening on port %d...\n", PORT);

    // 4. æ¥å—å®¢æˆ·ç«¯è¿æ¥
    client_len = sizeof(client_addr);
    client_fd = accept(server_fd, (struct sockaddr *)&client_addr, &client_len);
    if (client_fd < 0) {
        perror("accept failed");
        close(server_fd);
        exit(EXIT_FAILURE);
    }

    printf("Client connected: %s\n", inet_ntoa(client_addr.sin_addr));

    // 5. è¯»å–å®¢æˆ·ç«¯æ¶ˆæ¯
    memset(buffer, 0, BUFFER_SIZE);
    read(client_fd, buffer, BUFFER_SIZE);
    printf("Received from client: %s\n", buffer);

    // 6. å‘é€å“åº”
    char response[] = "Hello from server!";
    send(client_fd, response, strlen(response), 0);

    // 7. å…³é—­è¿æ¥
    close(client_fd);
    close(server_fd);
    return 0;
}

```

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬é€šè¿‡èµ°è¯»tcpçš„æºç ï¼Œæ¥ç†è§£tcpçš„è¿æ¥è¿‡ç¨‹ï¼Œä»¥åŠæ‰€æ¶‰åŠåˆ°çš„å„ä¸ªtcpé—®é¢˜ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å‡†å¤‡å‡ ä¸ªé—®é¢˜ï¼š

## **ğŸ“Œ ä¸€ã€TCP è¿æ¥ç®¡ç†**

### **1ï¸âƒ£ `socket()` å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ**

- `sys_socket()` å¦‚ä½•åˆ†é… socket ç»“æ„ï¼Ÿ
- socket åœ¨ `struct file` å’Œ `struct sock` ä¹‹é—´å¦‚ä½•å…³è”ï¼Ÿ
- `sock_init_data()` åœ¨ socket åˆå§‹åŒ–è¿‡ç¨‹ä¸­æ‰®æ¼”ä»€ä¹ˆè§’è‰²ï¼Ÿ

### **2ï¸âƒ£ `connect()` è¿‡ç¨‹**

- `connect()` è°ƒç”¨ `inet_stream_connect()` åï¼Œå¦‚ä½•è§¦å‘ `tcp_v4_connect()`ï¼Ÿ
- `tcp_connect()` å¦‚ä½•å¡«å…… TCP å¤´éƒ¨ï¼ˆ`SYN` åŒ…ï¼‰ï¼Ÿ
- `TCP ä¸‰æ¬¡æ¡æ‰‹` åœ¨æºç å±‚é¢æ˜¯å¦‚ä½•é©±åŠ¨çš„ï¼Ÿ
- `SS_CONNECTING â†’ SS_CONNECTED` çš„çŠ¶æ€è½¬æ¢æ˜¯å¦‚ä½•å‘ç”Ÿçš„ï¼Ÿ
- å¦‚æœ `connect()` æ˜¯éé˜»å¡çš„ï¼Œ`EINPROGRESS` å¦‚ä½•å¤„ç†ï¼Ÿ

### **3ï¸âƒ£ `listen()` å’Œ `accept()` è¿‡ç¨‹**

- `listen()` æ˜¯å¦‚ä½•å°† `socket` çŠ¶æ€è½¬æ¢ä¸º `TCP_LISTEN`ï¼Ÿ
- `backlog` å‚æ•°æ˜¯å¦‚ä½•ç®¡ç†ç­‰å¾…é˜Ÿåˆ—çš„ï¼Ÿ
- `accept()` å¦‚ä½•åœ¨ `sk->sk_receive_queue` è·å–æ–°çš„è¿æ¥ï¼Ÿ
- `struct sock` æ˜¯å¦‚ä½•è¢« `clone()` çš„ï¼Ÿ
- `accept()` è·å–çš„ `socket` ä¸ºä»€ä¹ˆç›´æ¥å¤„äº `SS_CONNECTED`ï¼Ÿ

------

## **ğŸ“Œ äºŒã€TCP æ•°æ®æ”¶å‘**

### **4ï¸âƒ£ `send()` å’Œ `recv()` è¿‡ç¨‹**

- `send()` è§¦å‘ `tcp_sendmsg()`ï¼Œæ•°æ®å¦‚ä½•è¢«ç»„ç»‡ï¼Ÿ
- `TCP_NODELAY` é€‰é¡¹å¦‚ä½•å½±å“æ•°æ®å‘é€ï¼Ÿï¼ˆNagle ç®—æ³•ï¼‰
- `recv()` å¦‚ä½•è·å– TCP **æ»‘åŠ¨çª—å£** ä¸­çš„æ•°æ®ï¼Ÿ
- `zero-copy sendfile()` å¦‚ä½•ä¼˜åŒ–ä¼ è¾“ï¼Ÿ
- `TCP å¿«é€Ÿé‡ä¼ ` åœ¨ `tcp_ack()` æ˜¯å¦‚ä½•è§¦å‘çš„ï¼Ÿ

### **5ï¸âƒ£ TCP ç¼“å†²åŒºç®¡ç†**

- å‘é€ç¼“å†²åŒº (`sk->sk_wmem_alloc`) å’Œæ¥æ”¶ç¼“å†²åŒº (`sk->sk_rmem_alloc`) å¦‚ä½•ç®¡ç†ï¼Ÿ
- `tcp_cleanup_rbuf()` åœ¨ `recv()` ä¹‹åæ˜¯å¦‚ä½•è°ƒæ•´çª—å£çš„ï¼Ÿ
- TCP çª—å£æ›´æ–° (`ACK`) ä½•æ—¶è§¦å‘ï¼Ÿ

------

## **ğŸ“Œ ä¸‰ã€TCP è¶…æ—¶ä¸é‡ä¼ **

### **6ï¸âƒ£ TCP è¶…æ—¶ä¸é‡ä¼ **

- `tcp_retransmit_timer()` ä»€ä¹ˆæ—¶å€™ä¼šè§¦å‘ï¼Ÿ
- `RTO (Retransmission Timeout)` å¦‚ä½•è®¡ç®—ï¼Ÿ
- `SACK (Selective Acknowledgment)` å¦‚ä½•ä¼˜åŒ–é‡ä¼ ï¼Ÿ
- å¦‚ä½•æŸ¥çœ‹ TCP çš„é‡ä¼ æ¬¡æ•°ï¼Ÿï¼ˆ`tcp_info`ï¼‰

### **7ï¸âƒ£ TCP Keepalive æœºåˆ¶**

- `TCP_KEEPALIVE` é€‰é¡¹å¦‚ä½•è§¦å‘ `keepalive` æ¢æµ‹ï¼Ÿ
- `tcp_keepalive_timer()` ä»€ä¹ˆæ—¶å€™ä¼šè§¦å‘ï¼Ÿ
- `keepalive` åœ¨å®‰å…¨åœºæ™¯ä¸‹å¦‚ä½•ç”¨äºæ£€æµ‹éæ­£å¸¸æ–­å¼€çš„è¿æ¥ï¼Ÿ

------

## **ğŸ“Œ å››ã€TCP è¿æ¥ç»ˆæ­¢**

### **8ï¸âƒ£ `close()` å’Œ `shutdown()`**

- `tcp_close()` å¦‚ä½•æ‰§è¡Œå››æ¬¡æŒ¥æ‰‹ï¼Ÿ
- `TIME_WAIT` çŠ¶æ€ä½•æ—¶è¿›å…¥ï¼Ÿå¦‚ä½•ä¼˜åŒ–ï¼Ÿ
- `SO_LINGER` é€‰é¡¹å¦‚ä½•å½±å“ `close()` è¡Œä¸ºï¼Ÿ
- æœåŠ¡å™¨ `close()` è¿æ¥æ—¶ï¼Œå¦‚ä½•å¤„ç†æœªè¯»æ•°æ®ï¼Ÿ

------

## **ğŸ“Œ äº”ã€TCP å®‰å…¨ä¸å¼‚å¸¸**

### **9ï¸âƒ£ SYN Flood æ”»å‡»å¦‚ä½•é˜²å¾¡ï¼Ÿ**

- `tcp_conn_request()` å¤„ç† SYN åŒ…æ—¶ï¼Œ`syn backlog` å¦‚ä½•ç®¡ç†ï¼Ÿ
- `syncookie` æœºåˆ¶åœ¨æºç ä¸­å¦‚ä½•å®ç°ï¼Ÿ
- `sysctl_tcp_max_syn_backlog` å¦‚ä½•é™åˆ¶ SYN é˜Ÿåˆ—ï¼Ÿ

### **ğŸ”Ÿ TCP Reset æ”»å‡»**

- `tcp_send_reset()` ä½•æ—¶å‘é€ `RST`ï¼Ÿ
- `TCP RST` æ”»å‡»å¦‚ä½•ä¼ªé€ ï¼Ÿ
- `tcp_rmem` / `tcp_wmem` å¦‚ä½•å½±å“æ‹’ç»æœåŠ¡æ”»å‡»ï¼Ÿ

### **ğŸ”¢ æ•°æ®åŒ…ä¹±åºå¤„ç†**

- `tcp_ofo_queue()` å¦‚ä½•å¤„ç†ä¹±åºæ•°æ®åŒ…ï¼Ÿ
- `tcp_try_coalesce()` ä½•æ—¶å°è¯•åˆå¹¶ TCP æ®µï¼Ÿ
- `reordering` ä½•æ—¶è§¦å‘ `fast retransmit`ï¼Ÿ

### **ğŸ”£ é˜²ç«å¢™å’Œ `iptables` å¦‚ä½•æ§åˆ¶ TCPï¼Ÿ**

- `TCP Conntrack` å¦‚ä½•è·Ÿè¸ªè¿æ¥ï¼Ÿ
- `iptables` å¦‚ä½•åŸºäº TCP æ ‡å¿—ä½è¿›è¡Œè¿‡æ»¤ï¼Ÿ
- `tcp_invalid()` å¦‚ä½•ä¸¢å¼ƒéæ³• TCP åŒ…ï¼Ÿ



## ç¬¬ä¸€éƒ¨åˆ†ï¼šsocketè¿‡ç¨‹

### 1ã€inet_sk(sk)å‡½æ•°ä»€ä¹ˆä½œç”¨

`inet_sk(sk)` è¿™ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯å°†ä¸€ä¸ªé€šç”¨çš„ `struct sock *` æŒ‡é’ˆè½¬æ¢ä¸º `struct inet_sock *` æŒ‡é’ˆï¼Œä»è€Œè®¿é—® `inet_sock` ç»“æ„ä½“ä¸­çš„ IPv4 ç›¸å…³å­—æ®µã€‚

------

**å‡½æ•°å®šä¹‰**

`inet_sk()` æ˜¯ä¸€ä¸ªé™æ€å†…è”å‡½æ•°ï¼Œé€šå¸¸å®šä¹‰åœ¨ Linux å†…æ ¸çš„ `include/net/inet_sock.h` å¤´æ–‡ä»¶ä¸­ï¼š

```c
static inline struct inet_sock *inet_sk(const struct sock *sk)
{
    return (struct inet_sock *)sk;
}
```

è¿™ä¸ªå‡½æ•°çš„æœ¬è´¨æ˜¯ **ç±»å‹è½¬æ¢**ï¼Œå³å°† `struct sock *` ç›´æ¥è½¬æ¢ä¸º `struct inet_sock *`ã€‚

------

**ä¸ºä»€ä¹ˆéœ€è¦ `inet_sk()`ï¼Ÿ**

åœ¨ Linux ç½‘ç»œåè®®æ ˆä¸­ï¼Œ`struct sock` æ˜¯é€šç”¨çš„ socket ç»“æ„ä½“ï¼Œé€‚ç”¨äº TCPã€UDP ç­‰å„ç§åè®®ã€‚å¯¹äºåŸºäº IPv4 çš„ socketï¼ˆå¦‚ `AF_INET` æ—çš„ `SOCK_STREAM` æˆ– `SOCK_DGRAM`ï¼‰ï¼ŒLinux é‡‡ç”¨ `struct inet_sock` æ¥æ‰©å±• `sock` ç»“æ„ï¼Œå¹¶å­˜å‚¨ IPv4 ç›¸å…³çš„ä¿¡æ¯ã€‚

`inet_sk(sk)` çš„ä½œç”¨å°±æ˜¯è®©**æˆ‘ä»¬ä»é€šç”¨çš„ `struct sock *` è½¬æ¢ä¸º `struct inet_sock *`ï¼Œä»è€Œè®¿é—® IPv4 ä¸“æœ‰çš„ socket ä¿¡æ¯ï¼Œæ¯”å¦‚æœ¬åœ°/è¿œç¨‹ IP åœ°å€ã€ç«¯å£å·ã€TOSï¼ˆType of Serviceï¼‰ã€TTLï¼ˆTime To Liveï¼‰ç­‰ã€‚**

------

**æ•°æ®ç»“æ„å…³ç³»**

`struct inet_sock` ç»§æ‰¿è‡ª `struct sock`ï¼Œå®ƒçš„å†…å­˜å¸ƒå±€å¦‚ä¸‹ï¼š

```c
struct inet_sock {
    struct sock sk;  // ç»§æ‰¿é€šç”¨çš„ sock ç»“æ„
    __be32 inet_saddr;   // æœ¬åœ° IPv4 åœ°å€
    __be32 inet_rcv_saddr;  // å®é™…æ¥æ”¶åˆ°æ•°æ®åŒ…çš„æœ¬åœ° IPv4 åœ°å€
    __be16 inet_sport;   // æœ¬åœ°ç«¯å£
    __be16 inet_num;     // ç»‘å®šçš„ç«¯å£å·
    __be32 inet_daddr;   // ç›®æ ‡ IPv4 åœ°å€
    __be16 inet_dport;   // ç›®æ ‡ç«¯å£
    __u8  inet_tos;      // Type of Service (TOS)
    __u8  inet_ttl;      // Time To Live (TTL)
    ...
};
```

ç”±äº `inet_sock` ç»“æ„çš„ç¬¬ä¸€é¡¹æ˜¯ `struct sock`ï¼Œæ‰€ä»¥ `inet_sk()` ç›´æ¥å°† `struct sock *` è½¬æ¢ä¸º `struct inet_sock *` æ˜¯å®‰å…¨çš„ã€‚

------

**ä½¿ç”¨ç¤ºä¾‹**

å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ª `struct sock *sk`ï¼Œæƒ³è¦è·å–å®ƒçš„æœ¬åœ° IPv4 åœ°å€ï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·å†™ï¼š

```c
struct sock *sk;
struct inet_sock *inet;

// è·å– inet_sock ç»“æ„
inet = inet_sk(sk);

// è®¿é—® IPv4 ç›¸å…³å­—æ®µ
__be32 local_ip = inet->inet_saddr;
__be16 local_port = inet->inet_sport;
```

è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä»ä¸€ä¸ªé€šç”¨ `sock` ç»“æ„ä½“ä¸­æå– IPv4 ç›¸å…³çš„ socket ä¿¡æ¯ã€‚

------

**æ€»ç»“**

- `inet_sk(sk)` çš„ä½œç”¨æ˜¯å°† `struct sock *` è½¬æ¢ä¸º `struct inet_sock *`ã€‚
- è¿™æ ·å¯ä»¥æ–¹ä¾¿åœ°è®¿é—® `inet_sock` ç»“æ„ä¸­ IPv4 ç›¸å…³çš„å­—æ®µï¼Œå¦‚æº IPã€ç›®æ ‡ IPã€ç«¯å£ç­‰ã€‚
- ç”±äº `inet_sock` ç»§æ‰¿è‡ª `sock`ï¼Œå¯ä»¥å®‰å…¨åœ°è¿›è¡Œç±»å‹è½¬æ¢ã€‚
- è¿™ä¸ªå‡½æ•°å¸¸ç”¨äº IPv4 ç½‘ç»œæ ˆçš„ä»£ç ï¼Œæ¯”å¦‚ TCPã€UDP ç»‘å®šç«¯å£ã€è¿æ¥è¿œç¨‹åœ°å€ç­‰æ“ä½œã€‚

------



### 2ã€sock_net(sk)ä½œç”¨è§£æ

`sock_net(sk)` ä½œç”¨æ˜¯ **è·å– socket æ‰€å±çš„ç½‘ç»œå‘½åç©ºé—´ï¼ˆnetwork namespaceï¼‰**ï¼Œè¿”å›ä¸€ä¸ª `struct net *` æŒ‡é’ˆã€‚

------

**å‡½æ•°å®šä¹‰**

åœ¨ Linux å†…æ ¸ä¸­ï¼Œ`sock_net(sk)` çš„å®šä¹‰é€šå¸¸ä½äº `include/net/sock.h` æ–‡ä»¶ï¼š

```c
static inline struct net *sock_net(const struct sock *sk)
{
    return sk->sk_net;
}
```

è¿™ä¸ªå‡½æ•° **ä» `struct sock` ç»“æ„ä½“ä¸­è·å– `sk_net` æˆå‘˜**ï¼Œè€Œ `sk_net` æŒ‡å‘çš„æ˜¯ä¸€ä¸ª `struct net *`ï¼Œä»£è¡¨ socket æ‰€åœ¨çš„ç½‘ç»œå‘½åç©ºé—´ã€‚

------

**ä¸ºä»€ä¹ˆéœ€è¦ `sock_net(sk)`ï¼Ÿ**

Linux å†…æ ¸æ”¯æŒ **ç½‘ç»œå‘½åç©ºé—´ï¼ˆNetwork Namespaceï¼‰**ï¼Œå®ƒå…è®¸å¤šä¸ªç‹¬ç«‹çš„ç½‘ç»œå †æ ˆå…±å­˜ã€‚ä¾‹å¦‚ï¼š

- **å®¹å™¨ï¼ˆDockerã€LXCï¼‰**ï¼šæ¯ä¸ªå®¹å™¨å¯ä»¥æ‹¥æœ‰è‡ªå·±çš„ç½‘ç»œå‘½åç©ºé—´ï¼Œæ‹¥æœ‰ç‹¬ç«‹çš„ IPã€è·¯ç”±è¡¨ç­‰ã€‚
- **VRFï¼ˆè™šæ‹Ÿè·¯ç”±å’Œè½¬å‘ï¼‰**ï¼šåŒä¸€ä¸ªç‰©ç†è®¾å¤‡å¯ä»¥æœ‰å¤šä¸ªé€»è¾‘ç½‘ç»œå®ä¾‹ã€‚

ç”±äº `struct sock` å¯èƒ½å±äºä¸åŒçš„ç½‘ç»œå‘½åç©ºé—´ï¼Œå› æ­¤åœ¨æ“ä½œ socket æ—¶ï¼Œå¿…é¡»é€šè¿‡ `sock_net(sk)` è·å–å…¶æ‰€å±çš„ `struct net` è¿›è¡Œæ­£ç¡®çš„ç½‘ç»œæ“ä½œã€‚



**Linux ç½‘ç»œå‘½åç©ºé—´çš„ä½œç”¨**

Linux **ç½‘ç»œå‘½åç©ºé—´ï¼ˆNetwork Namespace, netnsï¼‰** ä¸»è¦ç”¨äº **éš”ç¦»ç½‘ç»œèµ„æº**ï¼Œå®ƒå…è®¸ç³»ç»Ÿåˆ›å»ºå¤šä¸ªç›¸äº’ç‹¬ç«‹çš„ç½‘ç»œç¯å¢ƒï¼Œæ¯ä¸ªç½‘ç»œå‘½åç©ºé—´éƒ½æœ‰è‡ªå·±çš„ä¸€å¥—ç½‘ç»œè®¾å¤‡ã€IP åœ°å€ã€è·¯ç”±è¡¨ã€iptables è§„åˆ™ç­‰ã€‚

------

**è§£å†³çš„é—®é¢˜**

1. **ç½‘ç»œèµ„æºéš”ç¦»**
    - åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰€æœ‰è¿›ç¨‹å…±äº«åŒä¸€ä¸ªç½‘ç»œæ ˆã€‚ä½†åœ¨æŸäº›åœºæ™¯ä¸‹ï¼ˆå¦‚å®¹å™¨ã€è™šæ‹ŸåŒ–ã€å¤šç§Ÿæˆ·ç³»ç»Ÿï¼‰ï¼Œéœ€è¦å¯¹ä¸åŒåº”ç”¨æˆ–ç”¨æˆ·çš„ç½‘ç»œç¯å¢ƒè¿›è¡Œéš”ç¦»ã€‚
    - é€šè¿‡ç½‘ç»œå‘½åç©ºé—´ï¼Œå¯ä»¥ä¸ºä¸åŒè¿›ç¨‹åˆ†é…ç‹¬ç«‹çš„ç½‘ç»œæ¥å£å’Œè·¯ç”±è¡¨ï¼Œé¿å…ç›¸äº’å¹²æ‰°ã€‚
2. **å¤šç§Ÿæˆ·ï¼ˆMulti-Tenancyï¼‰æ”¯æŒ**
    - äº‘è®¡ç®—å’Œå¤šç§Ÿæˆ·ç¯å¢ƒä¸‹ï¼Œä¸åŒç§Ÿæˆ·çš„ç½‘ç»œé…ç½®åº”å½“å½¼æ­¤ç‹¬ç«‹ï¼Œé˜²æ­¢è·¨ç§Ÿæˆ·è®¿é—®ã€‚
    - é€šè¿‡ç½‘ç»œå‘½åç©ºé—´ï¼Œæ¯ä¸ªç§Ÿæˆ·å¯ä»¥æ‹¥æœ‰è‡ªå·±ç‹¬ç«‹çš„ IP åœ°å€ã€è·¯ç”±è¡¨ç­‰ï¼Œå¢å¼ºå®‰å…¨æ€§ã€‚
3. **å®¹å™¨å’Œè™šæ‹ŸåŒ–**
    - Dockerã€Kubernetes ç­‰å®¹å™¨æŠ€æœ¯åˆ©ç”¨ç½‘ç»œå‘½åç©ºé—´ï¼Œä¸ºæ¯ä¸ªå®¹å™¨æä¾›ç‹¬ç«‹çš„ç½‘ç»œç¯å¢ƒï¼Œä½¿å…¶æ‹¥æœ‰è‡ªå·±çš„ `eth0` æ¥å£ã€IP åœ°å€ç­‰ï¼ŒåŒæ—¶å¯ä»¥é€šè¿‡ `veth` è®¾å¤‡ä¸ä¸»æœºé€šä¿¡ã€‚
    - LXCã€VM ä¹Ÿé‡‡ç”¨ç½‘ç»œå‘½åç©ºé—´ï¼Œä»¥ç¡®ä¿è™šæ‹Ÿå®ä¾‹ä¹‹é—´çš„ç½‘ç»œéš”ç¦»ã€‚
4. **ç½‘ç»œæµ‹è¯•ä¸è°ƒè¯•**
    - å¼€å‘äººå‘˜å¯ä»¥ä½¿ç”¨ç½‘ç»œå‘½åç©ºé—´åˆ›å»ºå¤šä¸ªéš”ç¦»çš„ç½‘ç»œç¯å¢ƒï¼Œåœ¨åŒä¸€å°æœºå™¨ä¸Šæ¨¡æ‹Ÿä¸åŒçš„ç½‘ç»œæ‹“æ‰‘ï¼ˆå¦‚å¤šä¸ªå­ç½‘ã€ä¸åŒè·¯ç”±ç­–ç•¥ï¼‰ã€‚
    - ä¾‹å¦‚ï¼Œå¯ä»¥åœ¨æœ¬åœ°æµ‹è¯• SDNã€BGPã€VPN ç­‰ç½‘ç»œæŠ€æœ¯ï¼Œè€Œä¸å½±å“ä¸»æœºçš„å®é™…ç½‘ç»œé…ç½®ã€‚
5. **å®‰å…¨æ€§**
    - ç”±äºä¸åŒçš„ç½‘ç»œå‘½åç©ºé—´æ‹¥æœ‰ç‹¬ç«‹çš„ `iptables` è§„åˆ™ï¼Œå¯ä»¥é˜²æ­¢æ¶æ„è¿›ç¨‹è®¿é—®ä¸»æœºç½‘ç»œï¼Œä»è€Œæé«˜å®‰å…¨æ€§ã€‚
    - å¯ä»¥é™åˆ¶æŸäº›è¿›ç¨‹åªèƒ½è®¿é—®ç‰¹å®šçš„ç½‘ç»œèµ„æºï¼Œé¿å…æ•°æ®æ³„éœ²ã€‚

------

**æ•°æ®ç»“æ„å…³ç³»**

```c
struct sock {
    ...
#ifdef CONFIG_NET_NS
    struct net  *sk_net;  // è¯¥ socket æ‰€å±çš„ç½‘ç»œå‘½åç©ºé—´
#endif
    ...
};
```

`sk_net` ä»…åœ¨ **å†…æ ¸å¯ç”¨äº†ç½‘ç»œå‘½åç©ºé—´ï¼ˆCONFIG_NET_NSï¼‰** æ—¶å­˜åœ¨ã€‚å®ƒæ˜¯ä¸€ä¸ª `struct net *` æŒ‡é’ˆï¼ŒæŒ‡å‘è¯¥ socket æ‰€å±çš„ç½‘ç»œå‘½åç©ºé—´ã€‚

`struct net` å®šä¹‰äº†ä¸€ä¸ªç½‘ç»œå‘½åç©ºé—´ï¼ŒåŒ…å«è¯¥å‘½åç©ºé—´çš„è·¯ç”±è¡¨ã€ç½‘ç»œè®¾å¤‡ç­‰ä¿¡æ¯ï¼š

```c
struct net {
    struct list_head list;
    struct list_head exit_list;
    struct user_namespace *user_ns;
    ...
    struct netns_ipv4 ipv4;
    struct netns_ipv6 ipv6;
    ...
};
```

------

**ä½¿ç”¨ç¤ºä¾‹**

å‡è®¾ `sk` æ˜¯ä¸€ä¸ª socket ç»“æ„ä½“ï¼Œæˆ‘ä»¬æƒ³è¦è·å–å®ƒçš„ç½‘ç»œå‘½åç©ºé—´ï¼š

```c
struct sock *sk;
struct net *net_ns;

// è·å– socket æ‰€åœ¨çš„ç½‘ç»œå‘½åç©ºé—´
net_ns = sock_net(sk);

// åœ¨è¯¥å‘½åç©ºé—´å†…æ‰§è¡ŒæŸäº›æ“ä½œï¼Œä¾‹å¦‚è·å– IPv4 ç›¸å…³é…ç½®ï¼š
struct netns_ipv4 *ipv4_ns = &net_ns->ipv4;
```

------

**`sock_net(sk)` åœ¨ TCP/UDP ç»‘å®š (`bind()`) å’Œ è¿æ¥ (`connect()`) ä¸­çš„ä½œç”¨**

- å½“ **`bind()` ç»‘å®šæœ¬åœ° IP åœ°å€** æ—¶ï¼ŒLinux éœ€è¦åœ¨æ­£ç¡®çš„ç½‘ç»œå‘½åç©ºé—´å†…æŸ¥æ‰¾å¯ç”¨ IP åœ°å€ã€‚
- å½“ **`connect()` è¿æ¥è¿œç¨‹åœ°å€** æ—¶ï¼Œéœ€è¦æ£€æŸ¥è·¯ç”±è¡¨ï¼Œè€Œ `sock_net(sk)` å¯ä»¥ç¡®ä¿æŸ¥è¯¢çš„æ˜¯ **å½“å‰ socket æ‰€åœ¨çš„ç½‘ç»œå‘½åç©ºé—´** çš„è·¯ç”±è¡¨ã€‚

ç¤ºä¾‹ï¼š

```c
struct net *net = sock_net(sk);
struct rtable *rt = ip_route_output_key(net, &fl4);
```

è¿™é‡Œ `ip_route_output_key()` éœ€è¦ä¼ å…¥ `net`ï¼Œç¡®ä¿åœ¨æ­£ç¡®çš„ç½‘ç»œå‘½åç©ºé—´å†…è¿›è¡Œè·¯ç”±æŸ¥è¯¢ã€‚

------

**æ€»ç»“**

- `sock_net(sk)` ç”¨äºè·å– socket ç»“æ„ä½“ `sk` æ‰€å±çš„ **ç½‘ç»œå‘½åç©ºé—´**ï¼Œè¿”å› `struct net *`ã€‚
- è¯¥å‡½æ•°é€‚ç”¨äº **æ”¯æŒç½‘ç»œå‘½åç©ºé—´ï¼ˆNetwork Namespaceï¼‰çš„å†…æ ¸**ï¼Œç”¨äºåŒºåˆ†ä¸åŒå‘½åç©ºé—´ä¸­çš„ç½‘ç»œæ“ä½œã€‚
- ä¸»è¦ç”¨äº **socket ç»‘å®šï¼ˆbindï¼‰ã€è¿æ¥ï¼ˆconnectï¼‰ã€è·¯ç”±æŸ¥è¯¢ç­‰æ“ä½œ**ï¼Œç¡®ä¿åœ¨æ­£ç¡®çš„ç½‘ç»œç¯å¢ƒä¸­è¿›è¡Œæ“ä½œã€‚



### 3ã€inet_csk_get_port å‡½æ•°ä¸­çš„ä¸€äºŒçº§hash

åœ¨ `inet_csk_get_port` å‡½æ•°ä¸­ï¼Œæ¶‰åŠåˆ° **ä¸€çº§å“ˆå¸Œï¼ˆbhashï¼‰** å’Œ **äºŒçº§å“ˆå¸Œï¼ˆbhash2ï¼‰**ï¼Œå®ƒä»¬åˆ†åˆ«å¯¹åº”ä»¥ä¸‹æ•°æ®ç»“æ„ï¼š

- **ä¸€çº§å“ˆå¸Œï¼ˆbhashï¼‰**ï¼š
    - `inet_bind_hashbucket` ç»“æ„ï¼Œç”¨äºæ ¹æ®ç«¯å£å· (`port`) ç»„ç»‡ `inet_bind_bucket` ç»‘å®šæ¡¶ã€‚
    - ä½œç”¨ï¼šä¸»è¦ç”¨äºæ£€æŸ¥ç«¯å£æ˜¯å¦å·²è¢«å ç”¨ï¼Œå¹¶å­˜å‚¨ç«¯å£ç»‘å®šä¿¡æ¯ã€‚
    - ç»‘å®šè§„åˆ™ï¼šåªå…³æ³¨**ç«¯å£å·**ï¼Œä¸åŒºåˆ† IP åœ°å€ã€‚
- **äºŒçº§å“ˆå¸Œï¼ˆbhash2ï¼‰**ï¼š
    - `inet_bind2_bucket` ç»“æ„ï¼Œç”¨äºåŒæ—¶è€ƒè™‘**IP åœ°å€å’Œç«¯å£**è¿›è¡Œæ›´ç²¾ç¡®çš„ç»‘å®šç®¡ç†ã€‚
    - ä½œç”¨ï¼šè§£å†³å¤šä¸ªè¿›ç¨‹åœ¨ç›¸åŒç«¯å£ä½†ä¸åŒ IP åœ°å€ä¸Šçš„ç»‘å®šé—®é¢˜ï¼Œä¾‹å¦‚ `SO_REUSEPORT` å…è®¸å¤šä¸ªè¿›ç¨‹å…±äº«åŒä¸€ç«¯å£çš„æƒ…å†µã€‚
    - ç»‘å®šè§„åˆ™ï¼šåŒæ—¶åŒ¹é…**IP åœ°å€ + ç«¯å£å·**ï¼Œç¡®ä¿ç«¯å£å¤ç”¨çš„åˆç†æ€§ã€‚

------

**ä¸€çº§å“ˆå¸Œï¼ˆbhashï¼‰ VS äºŒçº§å“ˆå¸Œï¼ˆbhash2ï¼‰**

| ç‰¹æ€§         | ä¸€çº§å“ˆå¸Œï¼ˆbhashï¼‰      | äºŒçº§å“ˆå¸Œï¼ˆbhash2ï¼‰                       |
| ------------ | ---------------------- | ---------------------------------------- |
| ä¸»è¦å­˜å‚¨ç»“æ„ | `inet_bind_bucket`     | `inet_bind2_bucket`                      |
| å“ˆå¸Œæ–¹å¼     | ä»…æ ¹æ® `port` è®¡ç®—å“ˆå¸Œ | ä¾æ® `port + IP` è®¡ç®—å“ˆå¸Œ                |
| ä½œç”¨         | è§£å†³ç«¯å£å·çš„å ç”¨é—®é¢˜   | è§£å†³ç«¯å£å¤ç”¨é—®é¢˜ï¼Œæ”¯æŒ `SO_REUSEPORT` ç­‰ |
| é€‚ç”¨åœºæ™¯     | æ ‡å‡†ç«¯å£ç»‘å®š           | å¤æ‚ç«¯å£ç»‘å®šï¼Œä¾‹å¦‚å¤šä¸ªè¿›ç¨‹å…±äº«ç«¯å£       |

åœ¨ `inet_csk_get_port` ä»£ç ä¸­ï¼Œ**å…ˆæŸ¥è¯¢ä¸€çº§å“ˆå¸Œï¼ˆbhashï¼‰ï¼Œå¦‚æœå­˜åœ¨ç«¯å£å†²çªï¼Œåˆ™ä½¿ç”¨äºŒçº§å“ˆå¸Œï¼ˆbhash2ï¼‰è¿›ä¸€æ­¥ç¡®è®¤ç«¯å£æ˜¯å¦å¯ç”¨**ã€‚è¿™ç§è®¾è®¡èƒ½å¤Ÿå…¼é¡¾**æ•ˆç‡**å’Œ**çµæ´»æ€§**ï¼Œä¿è¯æ—¢èƒ½å¿«é€ŸæŸ¥æ‰¾ç«¯å£ä½¿ç”¨æƒ…å†µï¼Œåˆèƒ½æ”¯æŒå¤æ‚çš„ç«¯å£å¤ç”¨ç­–ç•¥ã€‚



### 4ã€listenå¯¹äºshutdownçš„ç‰¹æ®Šå¤„ç†

![image-20250313145903030](../typora-image/image-20250313145903030.png)

#### **1. èƒŒæ™¯ï¼šä¸ºä»€ä¹ˆè¦ç‰¹æ®Šå¤„ç† `shutdown()` ä¹‹åçš„ `listen`ï¼Ÿ**

é€šå¸¸ï¼Œåœ¨ `listen()` æ—¶ï¼Œå¯ä»¥é€šè¿‡ `TCP_FASTOPEN` é€‰é¡¹æ¥è®¾ç½® **Fast Open backlog**ï¼ˆå³å…è®¸å¤šå°‘ä¸ª **æœªå®Œæˆçš„ TFO è¿æ¥**ï¼‰ã€‚ä½†è¿™é‡Œæœ‰ä¸€ä¸ªç‰¹æ®Šæƒ…å†µï¼š

- å¦‚æœä¸€ä¸ª `listen` çŠ¶æ€çš„ socket **è°ƒç”¨äº† `shutdown()` è€Œä¸æ˜¯ `close()`**ï¼Œå®ƒçš„ **fastopen backlog å¯èƒ½ä»ç„¶ä¿ç•™**ã€‚
- è¿™æ ·ï¼Œ**å½“ socket é‡æ–°è¿›å…¥ `listen()` çŠ¶æ€æ—¶ï¼Œå®ƒå¯èƒ½å·²ç»æœ‰ backlog äº†**ï¼Œæ— éœ€é‡å¤è®¾ç½®ã€‚

ç„¶è€Œï¼Œå¦‚æœ `fastopenq.max_qlen` è¢«æ¸…ç©ºæˆ–æœªåˆå§‹åŒ–ï¼Œç³»ç»Ÿéœ€è¦é‡æ–°é…ç½® backlogï¼Œç¡®ä¿ TFO åŠŸèƒ½çš„æ­£å¸¸è¿è¡Œã€‚

------

#### **2. ä»£ç çš„é€»è¾‘åˆ†æ**

```c
tcp_fastopen = READ_ONCE(sock_net(sk)->ipv4.sysctl_tcp_fastopen);
```

- è¯»å–å…¨å±€ `sysctl_tcp_fastopen` å˜é‡ï¼Œåˆ¤æ–­ TFO æ˜¯å¦è¢«å¯ç”¨ã€‚

```c
if ((tcp_fastopen & TFO_SERVER_WO_SOCKOPT1) &&
    (tcp_fastopen & TFO_SERVER_ENABLE) &&
    !inet_csk(sk)->icsk_accept_queue.fastopenq.max_qlen) {
```

- åªæœ‰å½“ï¼š

    1. **TFO å…è®¸æ—  `TCP_FASTOPEN` é€‰é¡¹ (`TFO_SERVER_WO_SOCKOPT1`)**ï¼Œè¡¨ç¤ºå³ä½¿åº”ç”¨å±‚æ²¡æœ‰æ˜¾å¼å¯ç”¨ `TCP_FASTOPEN`ï¼Œç³»ç»Ÿä»ç„¶æ”¯æŒ TFOã€‚

    2. **TFO è¢«å…¨å±€å¯ç”¨ (`TFO_SERVER_ENABLE`)**ï¼Œç¡®ä¿ Fast Open æœºåˆ¶åœ¨å½“å‰ç³»ç»Ÿç¯å¢ƒä¸‹æ˜¯å¯ç”¨çš„ã€‚

    3. å½“å‰ `fastopenq.max_qlen == 0`

        ï¼Œå³ 

        Fast Open é˜Ÿåˆ—å°šæœªåˆå§‹åŒ–

        ï¼Œè¿™æ„å‘³ç€ï¼š

        - è¯¥ socket å¯èƒ½æ˜¯ç¬¬ä¸€æ¬¡å¯ç”¨ TFOï¼Œéœ€è¦åˆ†é… backlog é˜Ÿåˆ—ã€‚
        - ä¹‹å‰ `shutdown()` è¿‡ï¼Œä½† backlog è¢«æ¸…ç©ºäº†ï¼Œå¿…é¡»é‡æ–°é…ç½®ã€‚

```c
	fastopen_queue_tune(sk, backlog);
```

- **è°ƒæ•´ Fast Open è¿æ¥é˜Ÿåˆ—çš„å¤§å°**ï¼Œç¡®ä¿å…¶ç¬¦åˆ `backlog` è®¾å®šçš„å€¼ã€‚

```c
    tcp_fastopen_init_key_once(sock_net(sk));
```

- **åˆå§‹åŒ– TCP Fast Open çš„å¯†é’¥**ï¼Œä»¥ä¾¿æ”¯æŒ TFO è¿æ¥ä¸­çš„ cookie æœºåˆ¶ï¼ˆé˜²æ­¢ DoS æ”»å‡»ï¼‰ã€‚

------

#### **3. `backlog` åœ¨ TFO æœºåˆ¶ä¸­çš„ä½œç”¨**

`backlog` ä¸»è¦ç”¨äºæ§åˆ¶ **æœªå®Œæˆè¿æ¥**ï¼ˆåŒ…å«ä¸¤éƒ¨åˆ†ï¼‰ï¼š

1. **æ™®é€šçš„ `SYN` åŠè¿æ¥é˜Ÿåˆ—**ï¼ˆ`syn backlog`ï¼‰ï¼šå­˜æ”¾æœªå®Œæˆ **ä¸‰æ¬¡æ¡æ‰‹** çš„è¿æ¥ã€‚
2. **TFO åŠè¿æ¥é˜Ÿåˆ—**ï¼ˆ`fastopenq`ï¼‰ï¼šå­˜æ”¾ä½¿ç”¨ **TCP Fast Open** ç›´æ¥å‘é€æ•°æ®çš„è¿æ¥ã€‚

åœ¨ TCP Fast Open åœºæ™¯ä¸‹ï¼š

- å®¢æˆ·ç«¯ä¼šåœ¨ **SYN** ä¸­æºå¸¦æ•°æ®ï¼ŒæœåŠ¡å™¨æ”¶åˆ°å **ç›´æ¥å°†æ•°æ®äº¤ç»™åº”ç”¨å±‚**ï¼Œä½†è¿æ¥çŠ¶æ€ä»å¤„äº **åŠè¿æ¥**ï¼ˆæœªå®Œæˆæ¡æ‰‹ï¼‰ã€‚
- `fastopenq.max_qlen` æ§åˆ¶ **TFO åŠè¿æ¥é˜Ÿåˆ—çš„å¤§å°**ï¼Œå³å…è®¸å¤šå°‘ä¸ªç­‰å¾…å®Œæˆæ¡æ‰‹çš„ TFO è¿æ¥ã€‚
- å¦‚æœ `fastopenq.max_qlen` è¿‡å°ï¼Œå¯èƒ½ä¼šå¯¼è‡´æœåŠ¡å™¨ä¸¢å¼ƒ TFO è¿æ¥ï¼Œä»è€Œå½±å“æ€§èƒ½ã€‚

å½“ `shutdown()` å‘ç”Ÿæ—¶ï¼š

- æ™®é€š `backlog` å¯èƒ½ä»ç„¶ä¿ç•™ï¼Œä½† `fastopenq.max_qlen` å¯èƒ½è¢«æ¸…ç©ºï¼Œå› æ­¤éœ€è¦åœ¨ `listen()` é‡æ–°è®¾ç½®ã€‚
- è¿™ä¸ªä»£ç çš„ä½œç”¨å°±æ˜¯ **ç¡®ä¿ `fastopenq` é˜Ÿåˆ—å¤§å°æ­£ç¡®**ï¼Œé˜²æ­¢ `shutdown()` å½±å“åç»­ TFO è¿æ¥çš„å¤„ç†ã€‚

------

#### **4. ä»£ç çš„æ ¸å¿ƒä½œç”¨**

è¿™æ®µä»£ç çš„ç›®çš„æ˜¯ï¼š

1. **ç¡®ä¿ TCP Fast Open èƒ½å¤Ÿå¯ç”¨**ï¼Œå³ä½¿ **åº”ç”¨å±‚æ²¡æœ‰æ˜¾å¼è®¾ç½® `TCP_FASTOPEN` é€‰é¡¹**ã€‚
2. **è§£å†³ `shutdown()` å¯¼è‡´çš„ TFO backlog é—ç•™é—®é¢˜**ï¼Œé¿å… socket å¤ç”¨æ—¶ fastopenq è¢«é”™è¯¯åœ°æ¸…ç©ºæˆ–æœªåˆå§‹åŒ–ã€‚
3. **å¦‚æœ `fastopenq.max_qlen` è¿˜æ²¡è®¾ç½®ï¼Œåˆ™é‡æ–°é…ç½® TFO backlog**ï¼Œä¿è¯æ–°çš„ `listen()` ä¾ç„¶æ”¯æŒ TFOã€‚

------

#### **5. å½±å“**

- **å¦‚æœ socket ä¹‹å‰ `shutdown()` è¿‡ï¼Œä¸” TFO backlog ä»ç„¶å­˜åœ¨ï¼Œè¿™é‡Œå°±ä¸ä¼šé‡æ–°è®¾ç½® backlog**ï¼Œå› ä¸º `fastopenq.max_qlen` å¯èƒ½å·²ç»è¢«è®¾ç½®è¿‡ã€‚
- **å¦‚æœ socket æ˜¯å…¨æ–°çš„æˆ–è€…ä¹‹å‰ backlog è¢«æ¸…ç©ºï¼Œåˆ™è¿™é‡Œä¼šé‡æ–°åˆå§‹åŒ– fastopen é˜Ÿåˆ—**ï¼Œç¡®ä¿ TFO æ­£å¸¸å·¥ä½œã€‚

è¿™æ®µä»£ç çš„ä½œç”¨å°±æ˜¯ **åœ¨ TFO å…è®¸çš„æƒ…å†µä¸‹ï¼Œç¡®ä¿ fastopen backlog è¢«æ­£ç¡®é…ç½®ï¼Œé¿å… `shutdown()` å¯¼è‡´çš„ backlog é—ç•™é—®é¢˜**ã€‚



### 5ã€**listenä¸­inet_ulp_can_listenå‡½æ•°çš„ä½œç”¨**

`inet_ulp_can_listen` è¿™ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯ **æ£€æŸ¥å½“å‰ socket æ˜¯å¦å¯ä»¥è¿›å…¥ `listen` çŠ¶æ€**ï¼Œç‰¹åˆ«æ˜¯é’ˆå¯¹ **ULPï¼ˆUpper Layer Protocolï¼‰æœºåˆ¶çš„çº¦æŸ**ã€‚

------

**ä»£ç åˆ†æ**

```c
static int inet_ulp_can_listen(const struct sock *sk)
{
    const struct inet_connection_sock *icsk = inet_csk(sk);

    if (icsk->icsk_ulp_ops && !icsk->icsk_ulp_ops->clone)
        return -EINVAL;

    return 0;
}
```

**æ ¸å¿ƒé€»è¾‘**

1. å…ˆè·å– `sk` ç»“æ„ä½“çš„ `inet_connection_sock` ç‰ˆæœ¬ï¼š

    ```c
    const struct inet_connection_sock *icsk = inet_csk(sk);
    ```

    `inet_connection_sock` ç»“æ„ä½“æ˜¯ TCP ç›¸å…³çš„ socket ç»“æ„ï¼Œå®ƒæ‰©å±•äº†é€šç”¨çš„ `sock` ç»“æ„ï¼ŒåŒ…å«äº† TCP ç‰¹æœ‰çš„å­—æ®µï¼Œæ¯”å¦‚ `icsk_ulp_ops`ã€‚

2. ### **æ£€æŸ¥ ULPï¼ˆUpper Layer Protocolï¼‰æ˜¯å¦å…è®¸ `listen`**

    ```c
    if (icsk->icsk_ulp_ops && !icsk->icsk_ulp_ops->clone)
        return -EINVAL;
    ```

    - `icsk_ulp_ops` æ˜¯ **ULPï¼ˆUpper Layer Protocolï¼‰** æœºåˆ¶çš„ä¸€ä¸ªç»“æ„ï¼Œå…è®¸ TCP ä¹‹ä¸Šçš„åè®®ï¼ˆå¦‚ `TLS`ï¼‰æ¥ç®¡ TCP çš„éƒ¨åˆ†è¡Œä¸ºã€‚
    - å¦‚æœ `icsk_ulp_ops` **ä¸ä¸ºç©º**ï¼ˆè¯´æ˜è¯¥ socket ç»‘å®šäº†æŸä¸ª ULPï¼Œä¾‹å¦‚ TLSï¼‰ï¼Œä½† `icsk_ulp_ops->clone` **ä¸ºç©º**ï¼ˆè¯¥ ULP ä¸æ”¯æŒ `listen` çŠ¶æ€çš„å…‹éš†ï¼‰ï¼Œåˆ™è¿”å› `-EINVAL`ï¼ˆè¡¨ç¤ºæ— æ•ˆå‚æ•°ï¼‰ã€‚

3. å¦‚æœ `icsk_ulp_ops` ä¸ºç©ºï¼Œæˆ–è€… `icsk_ulp_ops->clone` å¯ç”¨ï¼Œåˆ™ `listen` å…è®¸æ‰§è¡Œï¼Œè¿”å› `0`ã€‚

------

**å‡½æ•°ä½œç”¨æ€»ç»“**

è¿™ä¸ªå‡½æ•°ç”¨äº **æ£€æŸ¥ socket æ˜¯å¦å¯ä»¥è¿›å…¥ `listen` çŠ¶æ€**ï¼Œç‰¹åˆ«æ˜¯ï¼š

- å¦‚æœ socket ç»‘å®šäº† **ULP æœºåˆ¶**ï¼ˆæ¯”å¦‚ `TLS`ï¼‰ï¼Œé‚£ä¹ˆå®ƒå¿…é¡»æ”¯æŒ `clone` æ“ä½œï¼Œæ‰èƒ½ `listen`ã€‚
- å¦‚æœç»‘å®šçš„ ULP **ä¸æ”¯æŒ `clone`**ï¼Œè¯´æ˜å®ƒä¸èƒ½ç”¨äº `listen`ï¼Œå› æ­¤è¿”å› `-EINVAL`ã€‚
- **æ™®é€š TCP socket** æ²¡æœ‰ç»‘å®šä»»ä½• ULPï¼Œå› æ­¤å¯ä»¥æ­£å¸¸ `listen`ï¼Œè¿”å› `0`ã€‚

------

**å¯èƒ½çš„å½±å“**

1. **å¦‚æœ socket ç»‘å®šäº†ä¸æ”¯æŒ `clone` çš„ ULPï¼ˆæ¯”å¦‚æŸäº› TLS å®ç°ï¼‰**
    - `listen()` è°ƒç”¨ä¼šå¤±è´¥ï¼Œè¿”å› `-EINVAL`ã€‚
    - è¿™æ ·åšæ˜¯ä¸ºäº†é¿å… ULP åœ¨ `listen` ä¹‹åï¼Œä¸èƒ½æ­£ç¡®å¤„ç†æ–°è¿æ¥çš„æƒ…å†µã€‚
2. **å¦‚æœ socket æ²¡æœ‰ç»‘å®š ULPï¼Œæˆ–è€…ç»‘å®šçš„ ULP æ”¯æŒ `clone`**
    - `listen()` æ­£å¸¸æ‰§è¡Œã€‚

------

**å®é™…åº”ç”¨**

åœ¨ Linux TCP åè®®æ ˆä¸­ï¼š

- è¿™ä¸ªå‡½æ•° **é€šå¸¸åœ¨ `inet_listen()` è¿‡ç¨‹ä¸­è¢«è°ƒç”¨**ï¼Œç”¨äº **æ£€æŸ¥æ˜¯å¦å…è®¸ socket è¿›å…¥ `listen` çŠ¶æ€**ã€‚
- **å½“ä½¿ç”¨ ULPï¼ˆå¦‚ TLS over TCPï¼‰æ—¶ï¼Œåªæœ‰æ”¯æŒ `clone` çš„ ULP æ‰èƒ½ `listen`**ï¼Œå¦åˆ™ `listen()` å¤±è´¥ã€‚

------

**æ€»ç»“**ï¼š

 `inet_ulp_can_listen()` **ç¡®ä¿ socket åœ¨ `listen()` ä¹‹å‰æ£€æŸ¥ ULP çº¦æŸ**ï¼Œé¿å…æŸäº›ä¸å…¼å®¹çš„ ULP è¿›å…¥ `listen`ï¼Œä»è€Œå¼•å‘é”™è¯¯ã€‚



### 6ã€Linuxçš„ç«¯å£å¤ç”¨

å¦‚æœä½ åœ¨ `0.0.0.0:8080` å’Œ `192.168.1.2:8080` ä¸ŠåŒæ—¶ç›‘å¬ï¼š

â€‹		é‚£ä¹ˆå®¢æˆ·ç«¯å‘ `192.168.1.2:8080` å‘é€æ•°æ®æ—¶ï¼Œ**åªæœ‰ `192.168.1.2:8080` ä¼šè§¦å‘**ã€‚

**åŸå› ï¼š**

- å½“ä½ ç»‘å®šåˆ° `0.0.0.0:8080` æ—¶ï¼Œå®ƒä¼šç›‘å¬æ‰€æœ‰ç½‘ç»œæ¥å£ä¸Šçš„ 8080 ç«¯å£ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œ`0.0.0.0:8080` ä¼šæ¥æ”¶æ¥è‡ªä»»ä½• IP åœ°å€ï¼ˆä¾‹å¦‚ `192.168.1.2` æˆ– `192.168.1.3`ï¼‰çš„è¯·æ±‚ã€‚
- å½“ä½ å†ç»‘å®šåˆ° `192.168.1.2:8080` æ—¶ï¼Œæ„å‘³ç€è¯¥æœåŠ¡åªä¼šç›‘å¬æ¥è‡ª `192.168.1.2` çš„è¯·æ±‚ã€‚

**å®¢æˆ·ç«¯å‘é€åˆ° `192.168.1.2:8080`ï¼š**

- å®¢æˆ·ç«¯å‘ `192.168.1.2:8080` å‘é€è¯·æ±‚æ—¶ï¼ŒæœåŠ¡ç»‘å®šåˆ° `192.168.1.2:8080` çš„ç›‘å¬ä¼šæ¥æ”¶è¿™ä¸ªè¯·æ±‚ã€‚
- **`0.0.0.0:8080` ä¸ä¼šè§¦å‘**ï¼Œå› ä¸ºè¯·æ±‚æ˜ç¡®å‘é€åˆ°äº† `192.168.1.2`ï¼Œè€Œä¸æ˜¯å…¶ä»–çš„ IP åœ°å€ã€‚`0.0.0.0` ç›‘å¬çš„æ˜¯æ‰€æœ‰æ¥å£çš„ 8080 ç«¯å£ï¼Œä½†ä¸ä¼šå†å¤„ç†å·²æ˜ç¡®æŒ‡å®šçš„ç›®æ ‡ IP åœ°å€ä¸Šçš„è¯·æ±‚ã€‚

**æ€»ç»“ï¼š**

- **`192.168.1.2:8080` ä¼šè§¦å‘**ã€‚
- **0.0.0.0:8080 ä¸ä¼šè§¦å‘**ï¼Œå› ä¸ºå·²ç»æœ‰äº†ä¸“é—¨ç»‘å®šåœ¨ `192.168.1.2:8080` ä¸Šçš„ç›‘å¬ã€‚



### 7ã€defer_connect æ ‡å¿—

`defer_connect` æ˜¯ä¸€ä¸ªæ ‡å¿—ï¼Œç”¨äºæ ‡è®°æ˜¯å¦å»¶è¿Ÿå¥—æ¥å­—è¿æ¥çš„å¤„ç†ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒä¸ TCP å¿«é€Ÿæ‰“å¼€ï¼ˆTCP Fast Openï¼‰ç‰¹æ€§ç›¸å…³ï¼Œå…è®¸åœ¨å¥—æ¥å­—çš„è¿æ¥æ“ä½œä¸­å»¶è¿Ÿè¿æ¥çš„å®é™…å»ºç«‹ã€‚

**è¯¦ç»†è§£é‡Šï¼š**

åœ¨ Linux å†…æ ¸ä¸­çš„ `inet_sk(sk)` ç»“æ„ä½“ä¸­ï¼Œ`defer_connect` æ˜¯ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œå®ƒé€šå¸¸ç”¨äº TCP å¥—æ¥å­—çš„å»¶è¿Ÿè¿æ¥æœºåˆ¶ï¼Œç‰¹åˆ«æ˜¯ä¸ TCP å¿«é€Ÿæ‰“å¼€ï¼ˆTCP Fast Openï¼ŒTFOï¼‰æœ‰å…³çš„å®ç°ã€‚

1. **TCP Fast Open (TFO)**ï¼š

TCP å¿«é€Ÿæ‰“å¼€æ˜¯ä¸€ä¸ªå¢å¼ºçš„ TCP è¿æ¥æœºåˆ¶ï¼Œå®ƒå¯ä»¥åœ¨ TCP æ¡æ‰‹é˜¶æ®µå‘é€æ•°æ®ï¼Œä»è€Œå‡å°‘å»¶è¿Ÿã€‚å¸¸è§çš„åº”ç”¨åœºæ™¯æ˜¯ HTTP è¯·æ±‚ï¼Œå¯ä»¥åœ¨å»ºç«‹è¿æ¥çš„åŒæ—¶å¼€å§‹ä¼ è¾“æ•°æ®ã€‚å¯ç”¨ TFO æ—¶ï¼Œå®¢æˆ·ç«¯åœ¨å‘èµ·è¿æ¥æ—¶å¯ä»¥åœ¨ SYN åŒ…ä¸­æºå¸¦æ•°æ®ã€‚

- `defer_connect` æ ‡å¿—ç”¨äºåœ¨ TCP Fast Open çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œå½“ `TCP_FASTOPEN_CONNECT` é€‰é¡¹å¯ç”¨æ—¶ï¼Œå»¶è¿Ÿè¿æ¥çš„å®é™…å»ºç«‹ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå°½ç®¡å®¢æˆ·ç«¯å¯èƒ½å·²ç»å¼€å§‹å‘é€æ•°æ®ï¼Œä½†åœ¨æŸäº›æ¡ä»¶ä¸‹ï¼ˆä¾‹å¦‚ï¼Œåœ¨å‘é€æ•°æ®ä¹‹å‰ï¼‰ï¼Œå†…æ ¸ä¸ä¼šç«‹å³å»ºç«‹è¿æ¥ã€‚
- ä¸€æ—¦è¿æ¥çš„æ¡æ‰‹è¿‡ç¨‹å®Œæˆï¼Œ`defer_connect` ä¼šè¢«æ¸…é™¤ï¼Œè¿æ¥å°†å®Œå…¨å»ºç«‹ï¼Œä¹‹åçš„é€šä¿¡å°†æ­£å¸¸è¿›è¡Œã€‚

2. **ä½œç”¨**ï¼š

- å¦‚æœ `defer_connect` ä¸ºçœŸï¼Œè¡¨ç¤º TCP Fast Open è¿æ¥æ­£åœ¨å»¶è¿Ÿå»ºç«‹ï¼Œå¥—æ¥å­—ä¸ä¼šç«‹å³è¿›è¡Œè¿æ¥æ“ä½œï¼Œç›´åˆ°ç›¸å…³çš„è¿æ¥å¤„ç†å®Œæˆã€‚
- å¦‚æœä¸ºå‡ï¼Œè¡¨ç¤ºè¿æ¥æ“ä½œä¸å†è¢«å»¶è¿Ÿï¼Œå†…æ ¸ä¼šè¿›è¡Œå¸¸è§„çš„è¿æ¥å»ºç«‹æµç¨‹ã€‚

3. **å…¸å‹åœºæ™¯**ï¼š

- **å®¢æˆ·ç«¯è¿æ¥æ—¶**ï¼šå®¢æˆ·ç«¯å¯ä»¥åœ¨è¿æ¥æ—¶å‘é€æ•°æ®ï¼Œå¦‚æœ `defer_connect` è¢«è®¾ç½®ä¸º `true`ï¼Œå†…æ ¸ä¸ä¼šç«‹åˆ»å®Œæˆè¿æ¥è¿‡ç¨‹ï¼Œè€Œæ˜¯ç­‰åˆ°å¿…è¦çš„æ¡ä»¶æ»¡è¶³åå†å®Œæˆã€‚
- **æœåŠ¡å™¨ç«¯**ï¼šæœåŠ¡å™¨ç«¯å¯ä»¥å¤„ç†ä¼ å…¥çš„è¿æ¥è¯·æ±‚ï¼Œå¹¶é€šè¿‡å†…æ ¸çš„è¿æ¥å¤„ç†æœºåˆ¶æœ€ç»ˆå»ºç«‹è¿æ¥ã€‚



### 8ã€tcpä¸è·¯ç”±çš„å…³ç³»

åœ¨ `tcp_v4_connect` ä»£ç ä¸­ï¼Œè·¯ç”±ï¼ˆRoutingï¼‰çš„ä¸»è¦ä½œç”¨æ˜¯**ç¡®å®šæ•°æ®åŒ…çš„ç›®çš„åœ°å’Œå‘é€è·¯å¾„**ï¼Œå¹¶ç¡®ä¿**TCP è¿æ¥å¯ä»¥æ­£ç¡®å»ºç«‹**ã€‚TCP åœ¨è¿æ¥å»ºç«‹é˜¶æ®µï¼Œéœ€è¦é€šè¿‡è·¯ç”±å­ç³»ç»Ÿæ¥è·å–å‘é€æ•°æ®æ‰€éœ€çš„ä¿¡æ¯ï¼Œå¦‚**ä¸‹ä¸€è·³åœ°å€ï¼ˆnexthopï¼‰**ã€**æº IP åœ°å€ï¼ˆsaddrï¼‰** å’Œ **è·¯ç”±ç¼“å­˜ï¼ˆrtï¼‰** ç­‰ã€‚

------

**è·¯ç”±çš„ä½œç”¨**

åœ¨ Linux å†…æ ¸ç½‘ç»œæ ˆä¸­ï¼Œè·¯ç”±ï¼ˆRoutingï¼‰ç”¨äºå†³å®šå¦‚ä½•å°†æ•°æ®åŒ…ä»æºåœ°å€å‘é€åˆ°ç›®æ ‡åœ°å€ã€‚å¯¹äº TCP è¿æ¥ï¼Œè·¯ç”±ç³»ç»Ÿçš„ä½œç”¨åŒ…æ‹¬ï¼š

1. **é€‰æ‹©åˆé€‚çš„ä¸‹ä¸€è·³ï¼ˆnexthopï¼‰**
    - å¦‚æœç›®æ ‡åœ°å€æ˜¯ç›´æ¥å¯è¾¾çš„ï¼ˆå¦‚æœ¬åœ°å­ç½‘å†…çš„ IPï¼‰ï¼Œåˆ™ `nexthop` ç›´æ¥æ˜¯ç›®æ ‡ IPã€‚
    - å¦‚æœç›®æ ‡åœ°å€ä¸å¯è¾¾ï¼ˆå¦‚ä¸åŒç½‘æ®µï¼‰ï¼Œåˆ™ `nexthop` å¯èƒ½æ˜¯ç½‘å…³çš„åœ°å€ã€‚
2. **æŸ¥æ‰¾æœ€ä½³è·¯ç”±ï¼ˆRoute Lookupï¼‰**
    - é€šè¿‡ `ip_route_connect()` æŸ¥æ‰¾åˆé€‚çš„è·¯ç”±è¡¨é¡¹ï¼Œè¿”å› `struct rtable *rt`ã€‚
    - å¦‚æœæ‰¾ä¸åˆ°è·¯ç”±ï¼Œåˆ™è¿”å› `-ENETUNREACH`ï¼ˆç½‘ç»œä¸å¯è¾¾ï¼‰ã€‚
3. **è·å–åˆé€‚çš„æºåœ°å€ï¼ˆSource Address Selectionï¼‰**
    - è‹¥ç”¨æˆ·æœªæŒ‡å®šæºåœ°å€ï¼ˆ`inet->inet_saddr` ä¸ºç©ºï¼‰ï¼Œåˆ™è·¯ç”±å­ç³»ç»Ÿä¼šæ ¹æ® `fl4->saddr` è‡ªåŠ¨é€‰æ‹©åˆé€‚çš„æº IP åœ°å€ã€‚
4. **ç¡®ä¿ç›®æ ‡åœ°å€åˆæ³•**
    - å¦‚æœç›®æ ‡åœ°å€æ˜¯å¹¿æ’­åœ°å€ï¼ˆRTCF_BROADCASTï¼‰æˆ–å¤šæ’­åœ°å€ï¼ˆRTCF_MULTICASTï¼‰ï¼ŒTCP è¿æ¥å°†å¤±è´¥ï¼Œè¿”å› `-ENETUNREACH`ã€‚
5. **å­˜å‚¨è·¯ç”±ä¿¡æ¯ï¼Œä»¥ä¾¿ TCP ä¼ è¾“ä½¿ç”¨**
    - ä¾‹å¦‚ `sk_setup_caps(sk, &rt->dst);` å°† `rt` å…³è”åˆ° `sk`ï¼Œç”¨äºåç»­ TCP æŠ¥æ–‡çš„å‘é€ã€‚

------

**TCP ä¸è·¯ç”±çš„å…³ç³»**

TCP æ˜¯**é¢å‘è¿æ¥**çš„ä¼ è¾“åè®®ï¼Œåœ¨å»ºç«‹è¿æ¥æ—¶ï¼ŒTCP éœ€è¦å€ŸåŠ© IP å±‚çš„è·¯ç”±ç³»ç»Ÿæ¥å®Œæˆä»¥ä¸‹ä»»åŠ¡ï¼š

1. **ç¡®å®šè¿œç«¯ IP æ˜¯å¦å¯è¾¾**
    - é€šè¿‡ `ip_route_connect()` æŸ¥è¯¢æ˜¯å¦å­˜åœ¨åˆ° `usin->sin_addr.s_addr`ï¼ˆç›®æ ‡åœ°å€ï¼‰çš„æœ‰æ•ˆè·¯ç”±ã€‚
    - è‹¥æ— è·¯ç”±ï¼Œåˆ™è¿æ¥å¤±è´¥ã€‚
2. **é€‰æ‹©åˆé€‚çš„æº IP**
    - TCP éœ€è¦ä¸€ä¸ªæœ¬åœ° IP ä½œä¸ºæºåœ°å€ï¼Œè‹¥ `inet->inet_saddr` ä¸ºç©ºï¼Œåˆ™ä»è·¯ç”±è¡¨è‡ªåŠ¨è·å–ã€‚
3. **ç»‘å®šè·¯ç”±åˆ° TCP è¿æ¥**
    - `sk_setup_caps(sk, &rt->dst);` ç»‘å®šè·¯ç”±ä¿¡æ¯åˆ° `sock`ï¼Œåç»­ TCP ä¼ è¾“æ•°æ®æ—¶ä¼šå¤ç”¨è¿™æ¡è·¯ç”±ã€‚
4. **é˜²æ­¢éæ³•è¿æ¥**
    - å¦‚æœç›®æ ‡åœ°å€æ˜¯å¹¿æ’­æˆ–å¤šæ’­ï¼ŒTCP ç›´æ¥æ‹’ç»è¿æ¥ï¼Œé¿å…æ— æ•ˆä¼ è¾“ã€‚
5. **å½±å“ TCP è¿æ¥çš„çŠ¶æ€å˜åŒ–**
    - å¦‚æœ `tcp_connect(sk)` æˆåŠŸï¼ŒTCP è¿›å…¥ `SYN_SENT` çŠ¶æ€ï¼Œç­‰å¾…æœåŠ¡å™¨ `SYN+ACK` å“åº”ã€‚
    - å¦‚æœè·¯ç”±ä¸å¯è¾¾ï¼ŒTCP è¿›å…¥ `CLOSE` çŠ¶æ€ï¼Œå¹¶è¿”å›é”™è¯¯ã€‚

------

**ä»£ç ä¸­çš„è·¯ç”±ç›¸å…³éƒ¨åˆ†**

```c
/* è·å–ç›®æ ‡åœ°å€ */
nexthop = daddr = usin->sin_addr.s_addr;

/* å¦‚æœå¯ç”¨äº† IP é€‰é¡¹ï¼ˆå¦‚æºè·¯ç”±ï¼‰ï¼Œä½¿ç”¨æŒ‡å®šçš„ä¸‹ä¸€è·³åœ°å€ */
inet_opt = rcu_dereference_protected(inet->inet_opt, lockdep_sock_is_held(sk));
if (inet_opt && inet_opt->opt.srr) {
    if (!daddr) return -EINVAL;
    nexthop = inet_opt->opt.faddr;
}

/* é€šè¿‡è·¯ç”±ç³»ç»ŸæŸ¥æ‰¾åˆ°ç›®æ ‡åœ°å€ï¼ˆnexthopï¼‰çš„è·¯å¾„ */
fl4 = &inet->cork.fl.u.ip4;
rt = ip_route_connect(fl4, nexthop, inet->inet_saddr,
                      sk->sk_bound_dev_if, IPPROTO_TCP, orig_sport,
                      orig_dport, sk);
if (IS_ERR(rt)) {
    err = PTR_ERR(rt);
    if (err == -ENETUNREACH)
        IP_INC_STATS(net, IPSTATS_MIB_OUTNOROUTES);
    return err;
}

/* å¦‚æœç›®æ ‡åœ°å€æ˜¯å¹¿æ’­æˆ–å¤šæ’­ï¼ŒTCP è¿æ¥ä¸æˆç«‹ */
if (rt->rt_flags & (RTCF_MULTICAST | RTCF_BROADCAST)) {
    ip_rt_put(rt);
    return -ENETUNREACH;
}

/* ç»‘å®šè·¯ç”±åˆ° socket */
sk_setup_caps(sk, &rt->dst);
```

------

**æ€»ç»“**

1. TCP ä¾èµ–è·¯ç”±å­ç³»ç»Ÿæ¥**å†³å®šå¦‚ä½•å‘é€æ•°æ®**ï¼ŒåŒ…æ‹¬ä¸‹ä¸€è·³ IP é€‰æ‹©ã€æºåœ°å€é€‰æ‹©å’Œè·¯ç”±ç¼“å­˜ç»‘å®šã€‚
2. åœ¨ `tcp_v4_connect()` é‡Œï¼Œè·¯ç”±ç³»ç»Ÿé€šè¿‡ `ip_route_connect()` æŸ¥æ‰¾åˆé€‚çš„è·¯ç”±ï¼Œå¹¶ç¡®ä¿ç›®æ ‡åœ°å€åˆæ³•ã€‚
3. TCP è¿æ¥å»ºç«‹æ—¶ï¼Œè·¯ç”±ä¼šå½±å“æº IP é€‰æ‹©ï¼Œå¹¶å†³å®šæ˜¯å¦å¯ä»¥æˆåŠŸå»ºç«‹è¿æ¥ã€‚
4. TCP è¿æ¥ç»‘å®šåˆ° `rt->dst`ï¼Œåç»­çš„æ•°æ®ä¼ è¾“éƒ½ä¼šä¾èµ–è¿™ä¸ªè·¯ç”±ä¿¡æ¯ã€‚





### 9ã€ä¸‰æ¬¡æ¡æ‰‹æµç¨‹ä¸ `accept()` çš„å…³ç³»

**ä¸‰æ¬¡æ¡æ‰‹æµç¨‹ä¸ `accept()` çš„å…³ç³»**

**æœåŠ¡å™¨ç«¯åœ¨ `listen()` ä¹‹åï¼Œå®¢æˆ·ç«¯ `connect()` è§¦å‘ TCP ä¸‰æ¬¡æ¡æ‰‹ï¼Œå†…æ ¸å®Œæˆè¿æ¥çš„å»ºç«‹ï¼Œåº”ç”¨å±‚ `accept()` åªæ˜¯ä»å†…æ ¸ä¸­å–å‡ºå·²å»ºç«‹çš„è¿æ¥ã€‚**

1. **æœåŠ¡å™¨è°ƒç”¨ `listen()` ä¹‹åï¼Œå†…æ ¸å°† socket ç½®ä¸º `TCP_LISTEN` çŠ¶æ€ï¼Œå¹¶å‡†å¤‡ `reqsk_queue`ï¼ˆåŠè¿æ¥é˜Ÿåˆ— + å…¨è¿æ¥é˜Ÿåˆ—ï¼‰ã€‚**
2. **å®¢æˆ·ç«¯è°ƒç”¨ `connect()` å‘é€ SYNï¼Œè¿›å…¥ `TCP_SYN_SENT` çŠ¶æ€ã€‚**
3. **æœåŠ¡å™¨æ”¶åˆ° SYNï¼Œå†…æ ¸è‡ªåŠ¨å›å¤ SYN+ACKï¼Œåˆ›å»º `request_sock` å¹¶åŠ å…¥åŠè¿æ¥é˜Ÿåˆ—ï¼ˆ`TCP_SYN_RECV` çŠ¶æ€ï¼‰ã€‚**
4. **å®¢æˆ·ç«¯æ”¶åˆ° SYN+ACKï¼Œå‘é€ ACKï¼Œå®Œæˆä¸‰æ¬¡æ¡æ‰‹ï¼ŒæœåŠ¡ç«¯è¿›å…¥ `TCP_ESTABLISHED` çŠ¶æ€ï¼Œå¹¶å°† `request_sock` è½¬ç§»åˆ°å…¨è¿æ¥é˜Ÿåˆ—ã€‚**
5. **åº”ç”¨å±‚ `accept()` åªæ˜¯ä»å…¨è¿æ¥é˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ªå·²ç»å»ºç«‹è¿æ¥çš„ socketï¼Œå¹¶è¿”å›ç»™ç”¨æˆ·æ€ã€‚**

------

**ä¸‰æ¬¡æ¡æ‰‹çš„å…·ä½“å†…æ ¸è°ƒç”¨æµç¨‹**

**åœ¨ `accept()` ä¹‹å‰ï¼Œä¸‰æ¬¡æ¡æ‰‹ä¸»è¦ç”±å†…æ ¸ `tcp_v4_rcv()` å®Œæˆ**ï¼š

**1. æœåŠ¡å™¨ `listen()`**

`inet_listen()` è®¾ç½® socket ä¸º `TCP_LISTEN`ï¼Œåˆå§‹åŒ– `icsk->icsk_accept_queue` é˜Ÿåˆ—ï¼ˆåŠè¿æ¥ + å…¨è¿æ¥é˜Ÿåˆ—ï¼‰ã€‚

**2. æœåŠ¡å™¨æ”¶åˆ°å®¢æˆ·ç«¯ `SYN`**

ç½‘ç»œé©±åŠ¨æ”¶åˆ°æ•°æ®åŒ…åï¼Œè¿›å…¥ `tcp_v4_rcv()` å¤„ç†ï¼š

- `tcp_v4_rcv()` â†’ `tcp_check_req()` è§£æ `SYN`ï¼Œåˆ›å»º `request_sock` å¹¶æ”¾å…¥ **åŠè¿æ¥é˜Ÿåˆ—** (`icsk_accept_queue`)ã€‚

**3. æœåŠ¡å™¨å‘é€ `SYN+ACK`**

- `tcp_v4_do_rcv()` â†’ `tcp_send_synack()` å‘é€ `SYN+ACK`ã€‚

**4. å®¢æˆ·ç«¯æ”¶åˆ° `SYN+ACK`ï¼Œå›å¤ `ACK`**

- `tcp_v4_rcv()` å¤„ç† `ACK`ï¼Œè°ƒç”¨ `tcp_v4_hnd_req()`
- `tcp_create_openreq_child()` ç”Ÿæˆæ–°çš„ `struct sock`
- `tcp_child_process()` å¤„ç†å®Œæ¯•åï¼Œè¿›å…¥ `TCP_ESTABLISHED` çŠ¶æ€ï¼Œ`request_sock` è½¬ç§»åˆ° **å…¨è¿æ¥é˜Ÿåˆ—**ã€‚



### 10ã€tcp_v4_rcvè°ƒç”¨å‡½æ•°æ ˆ

åœ¨ Linux å†…æ ¸ä¸­ï¼Œ`tcp_v4_rcv()` ä¸»è¦ç”¨äºå¤„ç† IPv4 TCP æ•°æ®åŒ…ï¼Œå®ƒçš„è°ƒç”¨é“¾è·¯ä»ç½‘ç»œè®¾å¤‡é©±åŠ¨ç¨‹åºå¼€å§‹ï¼Œæœ€ç»ˆä¼ é€’åˆ° TCP åè®®æ ˆã€‚ä»¥ä¸‹æ˜¯ `tcp_v4_rcv()` çš„å…¸å‹è°ƒç”¨æ ˆï¼š

------

**TCP æ•°æ®åŒ…çš„å†…æ ¸æ¥æ”¶æµç¨‹**

1. ç½‘ç»œè®¾å¤‡é©±åŠ¨æ¥æ”¶æ•°æ®
    - `netif_receive_skb()`ï¼ˆè½¯ä¸­æ–­ `NET_RX` å¤„ç†ï¼‰
    - `__netif_receive_skb_core()`
    - `ip_rcv()`ï¼ˆå¤„ç† IP å±‚ï¼‰
    - `ip_local_deliver()`ï¼ˆIP ç›®æ ‡åœ°å€åŒ¹é…æœ¬æœºï¼Œè¿›å…¥æœ¬æœºåè®®æ ˆï¼‰
    - `ip_protocol_deliver_rcu()`ï¼ˆæ ¹æ®åè®®å·è°ƒç”¨ TCP å¤„ç†å‡½æ•°ï¼‰
    - `tcp_v4_rcv()`ï¼ˆè¿›å…¥ TCP å±‚å¤„ç†é€»è¾‘ï¼‰

------

**å®Œæ•´çš„è°ƒç”¨æ ˆ**

```nginx
tcp_v4_rcv
â”œâ”€â”€ ip_protocol_deliver_rcu
â”‚   â”œâ”€â”€ ip_local_deliver
â”‚   â”‚   â”œâ”€â”€ ip_rcv
â”‚   â”‚   â”‚   â”œâ”€â”€ __netif_receive_skb_core
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ netif_receive_skb
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ __netif_receive_skb
â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ napi_gro_receive
â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ net_rx_action
â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ __do_softirq
â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ do_softirq
â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ __irq_exit_rcu
â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ irq_exit_rcu
â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ common_interrupt
â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ asm_common_interrupt
```

------

**å„ä¸ªå‡½æ•°çš„ä½œç”¨**

| å‡½æ•°                         | ä½œç”¨                                                     |
| ---------------------------- | -------------------------------------------------------- |
| `tcp_v4_rcv()`               | TCP å±‚å¤„ç† IPv4 ä¼ å…¥çš„æ•°æ®åŒ…                             |
| `ip_protocol_deliver_rcu()`  | æ ¹æ® IP å¤´éƒ¨çš„åè®®å·è°ƒç”¨ç›¸åº”åè®®çš„å¤„ç†å‡½æ•°ï¼ˆè¿™é‡Œæ˜¯ TCPï¼‰ |
| `ip_local_deliver()`         | å¤„ç†æœ¬æœºæ¥æ”¶çš„æ•°æ®åŒ…                                     |
| `ip_rcv()`                   | è§£æ IP å¤´éƒ¨ï¼Œæ ¡éªŒ IP å¤´éƒ¨å®Œæ•´æ€§                         |
| `__netif_receive_skb_core()` | è´Ÿè´£åˆ†å‘æ•°æ®åŒ…åˆ°ç›¸åº”çš„åè®®æ ˆï¼ˆIPv4ã€IPv6ç­‰ï¼‰             |
| `netif_receive_skb()`        | ç½‘ç»œè®¾å¤‡é©±åŠ¨è°ƒç”¨ï¼Œå¼€å§‹å¤„ç†æ•°æ®åŒ…                         |
| `napi_gro_receive()`         | è¿›è¡Œ GROï¼ˆGeneric Receive Offloadï¼‰èšåˆå¤„ç†              |
| `net_rx_action()`            | è½¯ä¸­æ–­å¤„ç†ç½‘ç»œæ•°æ®åŒ…                                     |
| `do_softirq()`               | è½¯ä¸­æ–­å…¥å£                                               |
| `irq_exit_rcu()`             | é€€å‡ºä¸­æ–­ï¼Œè§¦å‘è½¯ä¸­æ–­                                     |
| `common_interrupt()`         | å¤„ç†ç¡¬ä»¶ä¸­æ–­                                             |
| `asm_common_interrupt`       | å¤„ç† x86 å¹³å°ä¸Šçš„ä¸­æ–­è¯·æ±‚                                |