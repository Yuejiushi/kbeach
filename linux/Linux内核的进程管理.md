# Linux内核的进程管理

## 一、概述

Linux 的进程管理是操作系统管理的重要组成部分，它负责调度、创建、销毁进程，以及控制进程之间的通信和资源共享。以下是 Linux 进程管理的核心概念，以及如何使用 `top` 命令查看和管理进程信息。

### 1. **进程概念**

- **进程 (Process)**：进程是一个正在执行的程序的实例，包括程序的代码、数据、堆栈和其他运行时信息。每个进程有唯一的 PID（进程 ID）。

- **父进程与子进程**：进程可以通过 `fork()` 系统调用创建子进程，子进程继承父进程的资源。父进程与子进程通过 `PID` 和 `PPID`（父进程 ID）相关联。

- **进程状态**：

    - **R (Running)**：进程正在运行或在运行队列中等待 CPU。
    - **S (Sleeping)**：进程在等待某些事件（如 I/O 操作）完成。
    - **D (Uninterruptible sleep)**：进程正在等待不可中断的事件（如硬盘 I/O），不会被信号打断。
    - **T (Stopped)**：进程被暂停，可以通过 `SIGSTOP` 或 `SIGTSTP` 信号暂停。
    - **Z (Zombie)**：子进程已结束，但其退出状态尚未被父进程收集。

- **进程优先级与调度**：

    - Linux 通过调度器管理进程的执行顺序。调度器根据进程的优先级来决定哪个进程获得 CPU 资源。每个进程的优先级由 `nice` 值和调度策略共同决定。

    - **nice 值**：范围为 `-20` 到 `19`，负值表示更高的优先级，正值表示较低的优先级。

    - 调度策略

        ：

        - **SCHED_OTHER**：普通时间共享策略，适用于大部分进程。
        - **SCHED_FIFO** 和 **SCHED_RR**：实时调度策略，适用于时间敏感的任务。

### 2. **进程的生命周期**

- **创建**：通过 `fork()` 或 `clone()` 系统调用创建子进程，或者通过 `exec()` 替换当前进程的地址空间。
- **执行**：进程进入运行队列，等待内核调度器分配 CPU 执行。
- **阻塞**：进程等待某个事件（如 I/O 操作）时进入阻塞状态。
- **结束**：进程通过 `exit()` 系统调用终止运行，子进程结束后会进入僵尸状态，等待父进程收集其状态。

### 3. **进程间通信（IPC）**

Linux 提供了多种方式来实现进程间的通信（IPC），包括：

- **管道 (Pipe)**：父子进程之间的一种简单通信方式。
- **信号 (Signal)**：用于通知进程发生的事件（如 `SIGKILL` 用于终止进程，`SIGSTOP` 暂停进程）。
- **消息队列**、**共享内存**、**信号量**：用于更复杂的进程间通信。

### 4. **进程调度**

Linux 内核中的调度器负责决定哪个进程在某个时刻获得 CPU 使用权。调度器采用了多级反馈队列和基于优先级的算法。

- **实时进程与普通进程**：实时进程优先于普通进程被调度，实时进程使用 FIFO 或轮转调度策略，而普通进程使用完全公平调度器（CFS）。

### 5. **使用 `top` 命令查看进程信息**

`top` 是一个实时的任务管理器，用于监控系统性能和进程活动。它显示了系统中运行的进程、CPU 使用率、内存使用情况等信息，并允许用户对进程进行管理。

#### `top` 命令的基本使用

运行 `top` 命令会显示系统的实时信息，如下所示：

```bash
top
```

输出的主要字段说明：

- **PID**：进程 ID，唯一标识一个进程。
- **USER**：运行该进程的用户。
- **PR**：进程的优先级，越低的值表示越高的优先级。
- **NI**：进程的 `nice` 值，反映了用户设置的优先级调整。
- **VIRT**：进程使用的虚拟内存总量。
- **RES**：进程实际占用的物理内存。
- **SHR**：进程使用的共享内存。
- **S**：进程状态（如 `R`、`S`、`D` 等）。
- **%CPU**：进程占用的 CPU 使用率。
- **%MEM**：进程占用的物理内存百分比。
- **TIME+**：进程使用 CPU 的累计时间。
- **COMMAND**：启动进程的命令。

下表总结了 Linux 系统中使用 `top` 命令查看的各个进程信息字段及其对应作用：

| 字段    | 含义           | 作用与判断                                              |
| ------- | -------------- | ------------------------------------------------------- |
| PID     | 进程 ID        | 唯一标识进程，用于进程管理（如结束或调整进程）。        |
| USER    | 用户名         | 判断进程由哪个用户发起，识别非正常进程来源。            |
| PR      | 优先级         | 判断进程的调度优先级，低值意味着高优先级。              |
| NI      | nice 值        | 影响进程优先级，负值优先级高，正值优先级低。            |
| VIRT    | 虚拟内存占用   | 虚拟内存总量，高值可能指示内存泄漏或处理大数据。        |
| RES     | 常驻内存占用   | 实际占用的物理内存，高值可能引发内存不足问题。          |
| SHR     | 共享内存       | 共享内存大小，高值表示进程与其他进程共享资源较多。      |
| S       | 进程状态       | 判断进程状态：`R`（运行）、`S`（睡眠）、`Z`（僵尸）等。 |
| %CPU    | CPU 占用百分比 | 判断进程的 CPU 占用情况，识别高 CPU 占用的进程。        |
| %MEM    | 内存占用百分比 | 监控进程的物理内存占用，发现高内存占用或泄漏进程。      |
| TIME+   | 累计 CPU 时间  | 判断进程的 CPU 使用总量，识别 CPU 密集型任务。          |
| COMMAND | 启动命令       | 识别运行进程的可执行文件，快速定位进程的来源和作用。    |
| PPID    | 父进程 ID      | 追踪进程的父子关系，定位父进程对子进程的影响。          |
| PRI     | 调度优先级     | 影响进程获取 CPU 的频率，优先级高的进程优先获得资源。   |



#### `top` 命令中的常见操作

- **k**：终止某个进程。按 `k` 后，输入进程的 `PID`，然后确认是否终止该进程。
- **r**：调整某个进程的 `nice` 值。按 `r` 后，输入进程的 `PID` 和新的 `nice` 值。
- **P**：按 CPU 使用率排序。按 `P` 键可将进程按 CPU 使用率降序排列。
- **M**：按内存使用率排序。按 `M` 键可将进程按内存使用率降序排列。
- **T**：按运行时间排序。按 `T` 键可将进程按使用 CPU 的时间进行排序。
- **h**：查看帮助信息，显示 `top` 命令的所有快捷键。

#### 使用 `top` 过滤和排序

- 可以通过 `o` 键来增加排序字段，通过 `=` 键来恢复默认排序。
- 可以使用 `Shift + >` 和 `Shift + <` 来在不同列之间进行排序切换。



### 6. **`ps` 命令查看进程信息**

`ps` 是另一个常用的进程管理工具，它提供了当前系统中所有进程的快照（静态信息）。常用的 `ps` 命令选项：

- `ps -aux`：显示所有用户的所有进程，并提供详细信息。
- `ps -ef`：显示进程的完整格式，包括父子进程关系。



### 7. **杀死进程**

可以使用 `kill` 命令来终止进程：

```bash
kill <PID>
```

或者强制终止进程：

```bash
kill -9 <PID>
```
